<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrightRoute - Student Course Management Portal</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        // Tailwind configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#111827', // Very Dark Gray (almost black)
                        'secondary': '#374151', // Medium Gray (Action/Accent)
                        'accent': '#9ca3af', // Light Gray (Highlight/Indicator)
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 12px rgba(0, 0, 0, 0.08)',
                        'xl': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gray-50 text-inter min-h-screen flex antialiased">
    <div id="custom-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center transition-opacity duration-300">
        <div class="modal-content bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-3">Message</h3>
            <p id="modal-message" class="text-gray-600 mb-6">This is a confirmation message.</p>
            <div id="modal-actions" class="flex justify-end">
                <button id="modal-close-btn"
                    class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-gray-800 transition">Close</button>
            </div>
        </div>
    </div>

    <div id="sidebar-backdrop" class="fixed inset-0 bg-black opacity-0 hidden transition-opacity duration-300 lg:hidden"
        onclick="toggleSidebar(false)"></div>


    <div id="auth-flow" class="w-full flex justify-center items-center min-h-screen">

        <div class="max-w-md w-full p-6 space-y-8 bg-white rounded-xl shadow-xl">
            <h1 class="text-3xl font-extrabold text-primary text-center">BrightRoute</h1>

            <div id="register-view">
                <h2 class="text-2xl font-semibold text-primary mb-6 text-center">Create Your Account</h2>

                <form onsubmit="event.preventDefault(); handleRegister();" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="register-first-name" class="block text-sm font-medium text-gray-700">First
                                Name</label>
                            <input type="text" id="register-first-name" required
                                class="mt-1 w-full p-1 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                        </div>
                        <div>
                            <label for="register-last-name" class="block text-sm font-medium text-gray-700">Last
                                Name</label>
                            <input type="text" id="register-last-name" required
                                class="mt-1 w-full p-1 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                        </div>
                    </div>

                    <div>
                        <label for="register-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="register-email" required
                            class="mt-1 w-full p-1 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>

                    <div>
                        <label for="register-phone-number" class="block text-sm font-medium text-gray-700">Phone
                            Number</label>
                        <input type="tel" id="register-phone-number" required
                            class="mt-1 w-full p-1 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>

                    <div>
                        <label for="register-parent-phone-number" class="block text-sm font-medium text-gray-700">Parent
                            phone
                            Number</label>
                        <input type="tel" id="register-parent-phone-number" required
                            class="mt-1 w-full p-1 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Profile Picture (Optional)</label>
                        <input type="file" id="register-image-input" accept="image/*"
                            onchange="handleImageUpload(event)"
                            class="mt-1 w-full text-sm text-gray-500 file:mr-4 file:py-1 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-200 file:text-primary hover:file:bg-gray-300">
                        <input type="hidden" id="register-image-url">
                        <div id="image-preview"
                            class="w-20 h-20 rounded-full bg-gray-200 mt-2 flex items-center justify-center text-xs text-gray-500 overflow-hidden">
                            Preview
                        </div>
                    </div>

                    <div>
                        <label for="register-national-id" class="block text-sm font-medium text-gray-700">National ID (14
                            Digits)</label>
                        <input type="text" id="register-national-id" required
                            class="mt-1 w-full p-1 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>

                    <div>
                        <label for="register-id-type" class="block text-sm font-medium text-gray-700">Identification Type</label>
                        <select id="register-id-type" required onchange="toggleIdTypeFields(this.value)"
                            class="mt-1 w-full p-1 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary bg-white">
                            <option value="">Select ID Document Type...</option>
                            <option value="NATIONAL_ID">National ID Card</option>
                            <option value="BIRTH_CERTIFICATE">Birth Certificate</option>
                        </select>
                    </div>

                    <div id="national-id-front-group" class="hidden space-y-2 border p-3 rounded-lg bg-gray-50">
                        <label for="nationalIdFrontInput" class="block text-sm font-medium text-gray-700">Upload National ID Front Image</label>
                        <input type="file" id="nationalIdFrontInput" accept="image/*"
                            class="w-full text-sm text-gray-500 file:py-1 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-secondary file:text-white hover:file:bg-gray-600">
                    </div>

                    <div id="birth-certificate-group" class="hidden space-y-2 border p-3 rounded-lg bg-gray-50">
                        <label for="birthCertificateInput" class="block text-sm font-medium text-gray-700">Upload Birth Certificate Image</label>
                        <input type="file" id="birthCertificateInput" accept="image/*"
                            class="w-full text-sm text-gray-500 file:py-1 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-secondary file:text-white hover:file:bg-gray-600">
                    </div>
                    
                    <div>
                        <label for="register-level" class="block text-sm font-medium text-gray-700">Level</label>
                        <select id="register-level" required
                            class="mt-1 w-full p-1 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary bg-white">
                            <option value="">level of education...</option>
                            <option value="level 1">level 1</option>
                            <option value="level 2">level 2</option>
                            <option value="level 3">level 3</option>
                        </select>
                    </div>

                    <div>
                        <label for="register-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="register-password" required minlength="6"
                            class="mt-1 w-full p-1 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>

                    <div>
                        <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirm
                            Password</label>
                        <input type="password" id="confirm-password" required minlength="6"
                            class="mt-1 w-full p-1 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>

                    <div>
                        <label for="register-role" class="block text-sm font-medium text-gray-700">Role</label>
                        <select id="register-role" required
                            class="mt-1 w-full p-1 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary bg-white">
                            <option value="">Select Role...</option>
                            <option value="student">Student</option>
                            </select>
                    </div>

                    <button type="submit"
                        class="w-full py-3 bg-secondary text-white rounded-xl font-semibold hover:bg-gray-600 transition shadow-lg">
                        Register Account
                    </button>
                </form>

                <p class="mt-4 text-center text-sm text-gray-600">
                    Already have an account?
                    <a href="#" onclick="switchAuthView('login-view');"
                        class="font-medium text-primary hover:text-gray-800">Log in here</a>
                </p>
            </div>

            <div id="login-view" class="hidden">
                <h2 class="text-2xl font-semibold text-primary mb-6 text-center">Log in to your Portal</h2>

                <form onsubmit="event.preventDefault(); handleLogin();" class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="login-email" required
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>

                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="login-password" required
                            class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>

                    <button type="submit"
                        class="w-full py-3 bg-primary text-white rounded-xl font-semibold hover:bg-gray-800 transition shadow-lg">
                        Login
                    </button>
                </form>

                <p class="mt-4 text-center text-sm text-gray-600">
                    Need an account?
                    <a href="#" onclick="switchAuthView('register-view');"
                        class="font-medium text-secondary hover:text-gray-600">Register now</a>
                </p>
            </div>
        </div>

    </div>

    <div id="portal-flow" class="hidden flex flex-1 min-h-screen">

        <aside id="portal-sidebar"
            class="w-64 flex flex-col bg-gray-900 text-white shadow-xl h-screen lg:fixed lg:top-0">
            <div class="flex items-center justify-between h-20 bg-gray-800 p-4">
                <h1 class="text-xl font-bold tracking-wider" id="portal-title">BrightRoute</h1>
                <button class="p-2 text-gray-300 hover:text-white transition" onclick="toggleSidebar(false)"
                    id="sidebar-close-btn-in-sidebar">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <nav class="flex-1 p-4 space-y-2 custom-scrollbar overflow-y-auto">

                <a href="#"
                    class="nav-link flex items-center p-3 rounded-xl transition duration-150 text-gray-300 hover:bg-gray-700"
                    onclick="navigate('home-page-view')">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0h6m-6 0h.01">
                        </path>
                    </svg>
                    Home
                </a>

                <div id="nav-student" class="space-y-2 hidden">
                    <a href="#"
                        class="nav-link flex items-center p-3 rounded-xl transition duration-150 text-gray-300 hover:bg-gray-700"
                        onclick="navigate('dashboard-view')">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 8v8m-4-6v6m-4-2v4m-2 2h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                            </path>
                        </svg>
                        Dashboard
                    </a>

                    <a href="#"
                        class="nav-link flex items-center p-3 rounded-xl transition duration-150 text-gray-300 hover:bg-gray-700"
                        onclick="navigate('profile-view')">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        Profile
                    </a>
                </div>

                <div id="nav-admin" class="space-y-2 hidden">
                    <a href="#"
                        class="nav-link flex items-center p-3 rounded-xl transition duration-150 text-gray-300 hover:bg-gray-700"
                        onclick="navigate('admin-dashboard-view')">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19V6a1 1 0 011-1h4a1 1 0 011 1v13m-5 0A2 2 0 009 21h6a2 2 0 00-2-2m-3 0h6m-3-11v4m-3-4v4m-3 4h.01">
                            </path>
                        </svg>
                        Admin Dashboard
                    </a>
                    <a href="#"
                        class="nav-link flex items-center p-3 rounded-xl transition duration-150 text-gray-300 hover:bg-gray-700"
                        onclick="navigate('manage-courses-view')">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6.5v11M17.5 12h-11M9 21h6a2 2 0 002-2V5a2 2 0 00-2-2H9a2 2 0 00-2 2v14a2 2 0 002 2z">
                            </path>
                        </svg>
                        course Management
                    </a>
                    <a href="#"
                        class="nav-link flex items-center p-3 rounded-xl transition duration-150 text-gray-300 hover:bg-gray-700"
                        onclick="navigate('manage-lectures-view')">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 5a1 1 0 011-1h14a1 1 0 011 1v14a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM11 10a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 01-1 1h-2a1 1 0 01-1-1v-2z">
                            </path>
                        </svg>
                        Lecture Management
                    </a>
                    <a href="#"
                        class="nav-link flex items-center p-3 rounded-xl transition duration-150 text-gray-300 hover:bg-gray-700"
                        onclick="navigate('add-lecture-part-view')">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        Lecture Part Management
                    </a>
                    <a href="#"
                        class="nav-link flex items-center p-3 rounded-xl transition duration-150 text-gray-300 hover:bg-gray-700"
                        onclick="navigate('manage-users-view')">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 20h5m-1.25-5.5a4 4 0 10-8 0 4 4 0 008 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z">
                            </path>
                        </svg>
                        User Management
                    </a>
                </div>

                <a href="#"
                    class="nav-link flex items-center p-3 rounded-xl transition duration-150 text-gray-300 hover:bg-gray-700 mt-2"
                    onclick="handleLogout()">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                        </path>
                    </svg>
                    Logout
                </a>
            </nav>

            <div class="p-4 border-t border-gray-700 flex-shrink-0">
                <div class="flex items-center space-x-3">
                    <div
                        class="w-10 h-10 rounded-full ring-2 ring-gray-600 bg-gray-700 flex items-center justify-center font-bold text-lg">
                        <span id="user-initials">U</span>
                    </div>
                    <div>
                        <p class="font-medium text-sm" id="user-full-name">User Name</p>
                        <p class="text-xs text-gray-400 flex items-center">
                            Role: <span id="role-display" class="ml-1 font-semibold">Student</span>
                        </p>
                    </div>
                </div>
            </div>
        </aside>

        <div class="flex-1 flex flex-col main-content-wrapper">

            <nav id="dynamic-nav" class="bg-white shadow-soft p-4 sticky top-0 z-10 w-full">
                <div class="max-w-full mx-auto flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <button class="p-2 text-gray-700 hover:text-primary transition" onclick="toggleSidebar()">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <g id="sidebar-toggle-icon">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 6h16M4 12h16M4 18h16"></path>
                                </g>
                            </svg>
                        </button>
                        <h1 id="site-name-in-nav" class="text-xl font-extrabold text-primary hidden sm:block">
                            BrightRoute</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="nav-greeting-text" class="text-md font-medium text-gray-700 hidden sm:block">Hello,
                            User!</span>
                        <div id="nav-profile-icon" style="background-size: cover;"
                            class="w-10 h-10 rounded-full ring-2 ring-primary bg-gray-700 flex items-center justify-center font-bold text-lg text-white cursor-pointer"
                            onclick="navigate('profile-view')">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </nav>

            <main id="portal-main" class="flex-1 overflow-y-auto custom-scrollbar p-6"
                style="padding-left: 75px; padding-right: 75px;">

                <header class="flex justify-start items-center pb-6 border-b border-gray-200 mb-6">
                    <h2 class="text-3xl font-extrabold text-primary" id="current-portal-header">
                        Student Dashboard
                        <span id="current-user-role-badge"
                            class="ml-2 inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium bg-primary text-white">STUDENT</span>
                    </h2>

                    <button id="current-role-switch" class="hidden"></button>
                    <button id="notifications-button" class="hidden"></button>
                </header>
                <section id="add-lecture-part-view" class="app-view hidden space-y-8">
    <h1 class="text-3xl font-bold text-gray-800">Add 3 Content Parts to Lecture</h1>
    <p class="text-gray-600">Define up to 3 individual content parts (Video/Document) for the selected lecture.</p>

    <div class="bg-white p-6 rounded-xl shadow-soft max-w-2xl mx-auto">
        <form onsubmit="event.preventDefault(); addNewLecturePartFinal();" class="space-y-6">
            
            <div>
                <label class="block text-sm font-medium text-gray-700">1. Target Course</label>
                <select id="part-target-course" onchange="populateLectureDropdown(this.value, 'part-target-lecture')" required
                            class="mt-1 w-full p-2 border border-gray-300 rounded-lg bg-white">
                    <option value="">-- Select Course First --</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">2. Target Lecture</label>
                <select id="part-target-lecture" required
                            class="mt-1 w-full p-2 border border-gray-300 rounded-lg bg-white">
                    <option value="">-- Select Lecture --</option>
                </select>
            </div>

            <h4 class="text-md font-semibold text-gray-800 pt-2 border-t mt-4">3. Individual Content Parts</h4>

            <div class="space-y-2 p-3 border border-dashed border-gray-300 rounded-lg" id="part-group-1">
                <p class="font-bold text-sm text-primary">Part 1</p>
                <div>
                    <label class="block text-xs font-medium text-gray-700">Part Type</label>
                    <select id="part-type-1" class="mt-1 w-full p-2 border border-gray-300 rounded-lg bg-white">
                        <option value="">-- Select Type (Optional) --</option>
                        <option value="VIDEO">Video URL</option>
                        <option value="PDF">Document / File URL</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700">Content URL (Optional)</label>
                    <input type="url" id="part-url-1" placeholder="Paste URL here" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700">Part Description</label>
                    <textarea id="part-desc-1" rows="2" placeholder="Brief description of Part 1" class="mt-1 w-full p-2 border border-gray-300 rounded-lg"></textarea>
                </div>
            </div>

            <div class="space-y-2 p-3 border border-dashed border-gray-300 rounded-lg" id="part-group-2">
                <p class="font-bold text-sm text-primary">Part 2</p>
                <div>
                    <label class="block text-xs font-medium text-gray-700">Part Type</label>
                    <select id="part-type-2" class="mt-1 w-full p-2 border border-gray-300 rounded-lg bg-white">
                        <option value="">-- Select Type (Optional) --</option>
                        <option value="VIDEO">Video URL</option>
                        <option value="PDF">Document / File URL</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700">Content URL (Optional)</label>
                    <input type="url" id="part-url-2" placeholder="Paste URL here" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700">Part Description</label>
                    <textarea id="part-desc-2" rows="2" placeholder="Brief description of Part 2" class="mt-1 w-full p-2 border border-gray-300 rounded-lg"></textarea>
                </div>
            </div>

            <div class="space-y-2 p-3 border border-dashed border-gray-300 rounded-lg" id="part-group-3">
                <p class="font-bold text-sm text-primary">Part 3</p>
                <div>
                    <label class="block text-xs font-medium text-gray-700">Part Type</label>
                    <select id="part-type-3" class="mt-1 w-full p-2 border border-gray-300 rounded-lg bg-white">
                        <option value="">-- Select Type (Optional) --</option>
                        <option value="VIDEO">Video URL</option>
                        <option value="PDF">Document / File URL</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700">Content URL (Optional)</label>
                    <input type="url" id="part-url-3" placeholder="Paste URL here" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700">Part Description</label>
                    <textarea id="part-desc-3" rows="2" placeholder="Brief description of Part 3" class="mt-1 w-full p-2 border border-gray-300 rounded-lg"></textarea>
                </div>
            </div>
            
            <button type="submit"
                class="w-full py-3 bg-secondary text-white rounded-xl font-semibold hover:bg-gray-600 transition shadow-lg">
                Save All Parts
            </button>
        </form>
    </div>
</section>

                <section id="home-page-view" class="app-view hidden space-y-8">
                    <section class="hero-gradient py-16 text-center rounded-xl shadow-soft"
                        style="background: linear-gradient(45deg, #e3e3e3, #f6f6f6);">
                        <div class="max-w-4xl mx-auto px-6">
                            <h2 class="text-4xl font-black text-primary mb-4 leading-tight">Welcome to BrightRoute!</h2>
                            <p class="text-lg text-secondary mb-8">
                                Navigate through our structured learning paths and explore new opportunities.
                            </p>
                        </div>
                    </section>

                    <h2 class="text-3xl font-extrabold text-gray-900 text-center mb-4">Discover Your Learning Journey
                    </h2>
                    <p class="text-lg text-gray-600 text-center mb-10">Start from the basics and move to mastery through
                        our structured paths.</p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-11 level-card-grid" id="level-cards-container"
                        style="padding-left: 22px; padding-right: 22px;">
                        </div>
                </section>


                <section id="level-lectures-view" class="app-view hidden space-y-8">
                    <h1 class="text-3xl font-bold text-gray-800" id="current-level-title">Lectures in Level X</h1>
                    <p class="text-gray-600">This section details the lectures available within this course level. Click
                        'Go To Lecture' and use access code *LEVEL1JS* to unlock content.</p>

                    <button class="mb-4 text-primary font-medium flex items-center hover:text-gray-800 transition"
                        onclick="navigate('home-page-view')">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        Back to Home Page
                    </button>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-9" id="lectures-grid">
                        </div>
                </section>

                <section id="lecture-detail-view" class="app-view hidden space-y-8">
                    <h1 class="text-3xl font-bold text-gray-800" id="lecture-detail-title">Lecture: Details and Content
                    </h1>

                    <button class="mb-4 text-primary font-medium flex items-center hover:text-gray-800 transition"
                        onclick="navigate('level-lectures-view')">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        Back to Lectures List
                    </button>

                    <div class="flex flex-col lg:flex-row gap-6">

                        <div class="flex-1 bg-white p-6 rounded-xl shadow-soft">
                            <h3 class="text-2xl font-bold text-primary border-b pb-2">Lecture Parts</h3>

                            <div id="quiz-intro-content" class="lecture-part-content">
                                <h4 class="text-xl font-bold text-secondary">Pre-Content Quiz: Readiness Check</h4>
                                <p class="text-gray-600 mb-6">Before accessing the lecture videos and materials, you
                                    must successfully complete the entrance quiz.</p>

                                <button onclick="startQuiz()"
                                    class="mt-4 px-8 py-3 bg-primary text-white rounded-xl font-semibold hover:bg-gray-800 transition shadow-lg">
                                    Start Quiz Now
                                </button>
                                <p class="text-xs text-gray-500 mt-3">Content parts (2-5) are locked until the quiz is
                                    submitted successfully.</p>
                            </div>

                            <div id="quiz-content-actual" class="lecture-part-content hidden">
                                <h4 class="text-xl font-bold mb-4 text-secondary">Pre-Content Quiz (Mandatory)</h4>
                                <p class="text-gray-600 mb-6">Answer the following 10 questions to unlock the rest of
                                    the lecture content.</p>

                                <div class="space-y-4" id="quiz-questions-container">
                                    </div>
                                <button id="quiz-submit-btn" onclick="submitQuiz()"
                                    class="mt-6 px-6 py-2 bg-secondary text-white rounded-xl font-semibold hover:bg-gray-600 transition shadow-md">
                                    Submit Quiz
                                </button>
                            </div>

                            <div id="part1-content" class="lecture-part-content hidden">
                                <h4 class="text-xl font-bold mb-4">Part 1: Core Concepts Video</h4>
                                <div class="bg-gray-900 aspect-video rounded-lg flex items-center justify-center">
                                    <span class="text-white text-lg">Video Player Placeholder (Video 1)</span>
                                </div>
                                <p class="text-gray-600 mt-4">This section introduces the core framework syntax and
                                    setup environment.</p>
                            </div>

                            <div id="part2-content" class="lecture-part-content hidden">
                                <h4 class="text-xl font-bold mb-4">Part 2: Advanced Syntax Deep Dive Video</h4>
                                <div class="bg-gray-900 aspect-video rounded-lg flex items-center justify-center">
                                    <span class="text-white text-lg">Video Player Placeholder (Video 2)</span>
                                </div>
                                <p class="text-gray-600 mt-4">A detailed look into advanced features and practical
                                    coding examples.</p>
                            </div>

                            <div id="part3-content" class="lecture-part-content hidden">
                                <h4 class="text-xl font-bold mb-4">Part 3: Project Setup Guide Video</h4>
                                <div class="bg-gray-900 aspect-video rounded-lg flex items-center justify-center">
                                    <span class="text-white text-lg">Video Player Placeholder (Video 3)</span>
                                </div>
                                <p class="text-gray-600 mt-4">Setting up your local environment and starting your first
                                    project instance.</p>
                            </div>

                            <div id="part4-content" class="lecture-part-content hidden">
                                <h4 class="text-xl font-bold mb-4">Supplementary Materials (PDF)</h4>
                                <div class="bg-red-50 p-6 rounded-lg border-2 border-accent">
                                    <p class="text-primary font-semibold mb-2">Downloadable PDF: Summary Notes</p>
                                    <button
                                        class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-gray-800 transition">Download
                                        Materials</button>
                                </div>
                                <p class="text-gray-600 mt-4">Review the PDF document for quick reference and lecture
                                    summaries.</p>
                            </div>
                        </div>

                        <div class="w-full lg:w-80 flex-shrink-0 bg-gray-900 p-4 rounded-xl shadow-soft text-white">
                            <h3 class="text-lg font-bold mb-4 border-b border-gray-700 pb-2">Lecture Menu</h3>
                            <ul class="space-y-2">
                                <li>
                                    <button onclick="showLecturePart('quiz-content')"
                                        class="part-button w-full text-left p-3 rounded-xl bg-gray-600 text-white font-bold transition">
                                        1. Quiz (Required)
                                    </button>
                                </li>
                                <li>
                                    <button onclick="showLecturePart('part1-content')" disabled
                                        class="lecture-part-locked part-button w-full text-left p-3 rounded-xl opacity-50 cursor-not-allowed text-gray-300 hover:bg-gray-700 transition">
                                        2. Video: Core Concepts
                                    </button>
                                </li>
                                <li>
                                    <button onclick="showLecturePart('part2-content')" disabled
                                        class="lecture-part-locked part-button w-full text-left p-3 rounded-xl opacity-50 cursor-not-allowed text-gray-300 hover:bg-gray-700 transition">
                                        3. Video: Advanced Syntax
                                    </button>
                                </li>
                                <li>
                                    <button onclick="showLecturePart('part3-content')" disabled
                                        class="lecture-part-locked part-button w-full text-left p-3 rounded-xl opacity-50 cursor-not-allowed text-gray-300 hover:bg-gray-700 transition">
                                        4. Video: Project Setup
                                    </button>
                                </li>
                                <li>
                                    <button onclick="showLecturePart('part4-content')" disabled
                                        class="lecture-part-locked part-button w-full text-left p-3 rounded-xl opacity-50 cursor-not-allowed text-gray-300 hover:bg-gray-700 transition">
                                        5. PDF: Materials & Notes
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>

                </section>


                <section id="dashboard-view" class="app-view hidden space-y-8">

                    <h1 class="text-3xl font-bold text-gray-800" id="dashboard-greeting">Dashboard</h1>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-soft border-t-4 border-primary card-hover-effect">
                            <p class="text-sm font-medium text-gray-500">Enrolled Courses</p>
                            <p class="text-4xl font-extrabold text-primary mt-1">4</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-soft border-t-4 border-secondary card-hover-effect">
                            <p class="text-sm font-medium text-gray-500">Avg. Quiz Score</p>
                            <p class="text-4xl font-extrabold text-primary mt-1">82<span
                                    class="text-xl font-normal text-secondary">%</span></p>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-soft border-t-4 border-accent card-hover-effect">
                            <p class="text-sm font-medium text-gray-500">Active Lessons</p>
                            <p class="text-4xl font-extrabold text-primary mt-1">5</p>
                        </div>
                    </div>


                    <div class="bg-white p-6 rounded-xl shadow-soft">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Your Courses (In Progress)</h3>
                        <div id="student-courses-list" class="space-y-4">
                            </div>
                    </div>

                </section>


                <section id="admin-dashboard-view" class="app-view hidden space-y-8">

                    <h1 class="text-3xl font-bold text-gray-800" id="admin-dashboard-greeting">Admin Dashboard</h1>
                    <p class="text-gray-600">Quick statistics and access to critical operations.</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-soft border-t-4 border-primary card-hover-effect">
                            <p class="text-sm font-medium text-gray-500">Total Students</p>
                            <p class="text-4xl font-extrabold text-primary mt-1">4,521</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-soft border-t-4 border-secondary card-hover-effect">
                            <p class="text-sm font-medium text-gray-500">Active Courses</p>
                            <p class="text-4xl font-extrabold text-secondary mt-1">54</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-soft border-t-4 border-accent card-hover-effect">
                            <p class="text-sm font-medium text-gray-500">Unresolved Tickets</p>
                            <p class="text-4xl font-extrabold text-accent mt-1">12</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-soft border-t-4 border-red-500 card-hover-effect">
                            <p class="text-sm font-medium text-gray-500">Enrollment Rate (Month)</p>
                            <p class="text-4xl font-extrabold text-red-500 mt-1">+1.5<span
                                    class="text-xl font-normal text-red-500">%</span></p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <button onclick="navigate('manage-courses-view')"
                            class="flex items-center justify-center p-6 bg-white rounded-xl shadow-soft border border-gray-100 hover:bg-gray-100 transition duration-150 group">
                            <svg class="w-8 h-8 text-primary group-hover:text-gray-800 mr-3" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                </path>
                            </svg>
                            <span class="text-lg font-semibold text-primary">Add New Content</span>
                        </button>
                        <button onclick="navigate('manage-users-view')"
                            class="flex items-center justify-center p-6 bg-white rounded-xl shadow-soft border border-gray-100 hover:bg-gray-100 transition duration-150 group">
                            <svg class="w-8 h-8 text-secondary group-hover:text-gray-600 mr-3" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a4 4 0 014-4h8a4 4 0 014 4v1m-2-4a4 4 0 100-8 4 4 0 000 8z">
                                </path>
                            </svg>
                            <span class="text-lg font-semibold text-primary">Manage Users</span>
                        </button>
                        <button
                            class="flex items-center justify-center p-6 bg-white rounded-xl shadow-soft border border-gray-100 hover:bg-gray-100 transition duration-150 group">
                            <svg class="w-8 h-8 text-accent group-hover:text-gray-500 mr-3" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                </path>
                            </svg>
                            <span class="text-lg font-semibold text-primary">View Detailed Reports</span>
                        </button>
                    </div>
                </section>


                <section id="profile-view" class="app-view hidden space-y-8 max-w-4xl mx-auto">
                    <h1 class="text-3xl font-bold text-gray-800">User Profile & Settings</h1>
                    <div class="bg-white p-8 rounded-xl shadow-soft space-y-6" id="profile-edit-form"
                        data-editing="false">

                        <div class="flex items-center space-x-6 border-b pb-4">
                            <div id="profile-initials-large" style="background-size: cover;"
                                class="w-20 h-20 rounded-full ring-4 ring-primary bg-gray-700 flex items-center justify-center font-bold text-3xl text-white">
                                U</div>
                            <div>
                                <h3 class="text-2xl font-bold text-primary" id="profile-name">User Name</h3>
                                <p class="text-secondary font-medium" id="profile-role">Student Portal</p>
                            </div>
                        </div>


                        <div id="profile-data-container">
                            </div>

                        <div class="flex space-x-4">
                            <button id="edit-profile-btn" onclick="toggleEditMode(true)"
                                class="px-6 py-2 bg-primary text-white rounded-xl hover:bg-gray-800 transition font-semibold">Edit
                                Profile</button>
                            <button id="save-profile-btn" onclick="saveProfileChanges()"
                                class="px-6 py-2 bg-secondary text-white rounded-xl hover:bg-gray-600 transition font-semibold hidden">Save
                                Changes</button>
                        </div>
                    </div>
                </section>


                <section id="manage-users-view" class="app-view hidden space-y-8">
                    <h1 class="text-3xl font-bold text-gray-800">User Management</h1>
                    <p class="text-gray-600">View, search, and manage user accounts and roles. (Admin Tool)</p>

                    <div class="bg-white p-6 rounded-xl shadow-soft">
                        <div class="flex justify-between items-center mb-4">
                            <input type="text" placeholder="Search users by name or email..."
                                class="p-3 border border-gray-300 rounded-lg w-1/2">
                            </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Name</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Role</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Email</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="user-table-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </section>


                <section id="manage-courses-view" class="app-view hidden space-y-8">
                    <h1 class="text-3xl font-bold text-gray-800">Course Management</h1>
                    <p class="text-gray-600">Create, edit, and publish courses. (Admin Tool)</p>

                    <div class="bg-white p-6 rounded-xl shadow-soft">
                        <div class="flex justify-between items-center mb-4">
                            <input type="text" placeholder="Search content..."
                                class="p-3 border border-gray-300 rounded-lg w-1/2">
                            <button onclick="showAddCourseModal();"
                                class="px-4 py-2 bg-primary text-white rounded-xl hover:bg-gray-800 transition font-semibold">Create
                                New Course</button>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <tbody class="bg-white divide-y divide-gray-200" id="course-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section id="manage-lectures-view" class="app-view hidden space-y-8">
                    <h1 class="text-3xl font-bold text-gray-800">Lecture Management</h1>
                    <p class="text-gray-600">Manage individual lectures and their internal content parts (Videos,
                        Files). (Admin Tool)</p>

                    <div class="bg-white p-6 rounded-xl shadow-soft">
                        <div class="flex justify-between items-center mb-4">
                            <input type="text" placeholder="Search lectures by title or course..."
                                class="p-3 border border-gray-300 rounded-lg w-1/2">
                            <button onclick="showAddLectureModal();"
                                class="px-4 py-2 bg-secondary text-white rounded-xl font-semibold hover:bg-gray-600 transition">Add
                                New Lecture</button>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Lecture Title</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Course Name</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Parts Count</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="lecture-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section id="course-detail-view" class="app-view hidden space-y-8">
                    <h1 class="text-3xl font-bold text-gray-800">Advanced Web Development with React</h1>
                    <p class="text-xl text-primary font-medium">Course Overview and Syllabus</p>

                    <button class="mb-4 text-primary font-medium flex items-center hover:text-gray-800 transition"
                        onclick="navigate('dashboard-view')">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        Back to Dashboard
                    </button>

                    <div class="bg-white p-6 rounded-xl shadow-soft">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Syllabus Breakdown (3 Modules)</h3>
                        <ul class="space-y-4">
                            <li class="p-4 bg-gray-50 rounded-lg border-l-4 border-primary">
                                <span class="font-bold text-gray-900">Module 1: React Fundamentals (10 Lectures)</span>
                                <p class="text-sm text-gray-600">Covers JSX, components, state, and props.</p>
                            </li>
                            <li class="p-4 bg-gray-50 rounded-lg border-l-4 border-secondary">
                                <span class="font-bold text-gray-900">Module 2: Hooks and Context (15 Lectures)</span>
                                <p class="text-sm text-gray-600">Deep dive into useState, useEffect, useContext, and
                                    custom hooks.</p>
                            </li>
                            <li class="p-4 bg-gray-50 rounded-lg border-l-4 border-accent">
                                <span class="font-bold text-gray-900">Module 3: Routing and Deployment (5
                                    Lectures)</span>
                                <p class="text-sm text-gray-600">Implementing client-side routing, API fetching, and
                                    final deployment strategies.</p>
                            </li>
                        </ul>
                    </div>
                </section>

            </main>

            <footer
                class="portal-footer bg-white border-t border-gray-100 p-4 text-center text-xs text-gray-500 shadow-inner">
                <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center text-gray-500">
                    <p class="order-2 sm:order-1 mt-2 sm:mt-0"> 2025 BrightRoute SCMS. All rights reserved.</p>
                    <div class="order-1 sm:order-2 space-x-4 text-sm">
                        <a href="#" class="hover:text-primary transition">Privacy Policy</a>
                        <span class="text-gray-300">|</span>
                        <a href="#" class="hover:text-primary transition">Terms of Use</a>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <script>
        // =======================================================
        // MOCK/HELPER FUNCTIONS (Required by the core logic)
        // =======================================================
        const SERVER_URL = 'http://localhost:7070/api/users'; // **UPDATE THIS TO YOUR REAL SERVER URL**

        let registeredUsers = [
            // Mock Student
            { id: 1, firstName: 'Demo', lastName: 'Student', email: 'student@br.com', password: '123', role: 'student', level: 'level 2', phoneNumber: '123456789', imageUrl: null },
            // Mock Admin
            { id: 2, firstName: 'Demo', lastName: 'Admin', email: 'admin12@gmail.com', password: 'admin123', role: 'admin', level: 'N/A', phoneNumber: '987654321', imageUrl: null }
        ];

        function showMessage(title, message) {
            // Function to display messages (Using the provided modal structure)
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            if (modal && modalTitle && modalMessage) {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modal.classList.remove('hidden');

                modalCloseBtn.onclick = () => {
                    modal.classList.add('hidden');
                };
            }
            console.log(`[${title}]: ${message}`);
        }

        function updateProfileIcon(user) {
            const initials = (user.firstName ? user.firstName[0] : 'U') + (user.lastName ? user.lastName[0] : '');
            document.getElementById('user-initials').textContent = initials;
            document.getElementById('nav-greeting-text').textContent = `Hello, ${user.firstName || 'User'}!`;
            // Note: In a real app, if user.imageUrl is a URL, you'd set a background image on nav-profile-icon
        }

        function updateSidebarUserInfo(user) {
            const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || 'User';
            document.getElementById('user-full-name').textContent = fullName;
        }

        function navigate(viewId) {
            // Function to handle switching between main portal views
            localStorage.setItem('currentView', viewId);
            document.querySelectorAll('.app-view').forEach(view => {
                view.classList.add('hidden');
            });
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.remove('hidden');
            } else {
                console.error(`View with ID ${viewId} not found. Falling back to home-page-view.`);
                // We assume 'home-page-view' exists based on the HTML provided
                const homeView = document.getElementById('home-page-view');
                if (homeView) homeView.classList.remove('hidden');
            }
        }
        
        function toggleSidebar(shouldOpen) {
            const sidebar = document.getElementById('portal-sidebar');
            const backdrop = document.getElementById('sidebar-backdrop');
            const wrapper = document.querySelector('.main-content-wrapper');

            // Determine current state if not explicitly passed
            const isOpen = shouldOpen === undefined ? sidebar.classList.contains('translate-x-0') : shouldOpen;

            if (window.innerWidth < 1024) { // Mobile toggle behavior
                if (isOpen) {
                    sidebar.classList.remove('translate-x-0');
                    sidebar.classList.add('-translate-x-full');
                    backdrop.classList.add('hidden');
                    backdrop.classList.remove('opacity-50');
                } else {
                    sidebar.classList.remove('-translate-x-full');
                    sidebar.classList.add('translate-x-0');
                    backdrop.classList.remove('hidden');
                    backdrop.classList.add('opacity-50');
                }
            } else { // Desktop sticky behavior
                if (isOpen) {
                    sidebar.style.transform = 'translateX(0)';
                    wrapper.style.marginLeft = '256px'; 
                } else {
                    sidebar.style.transform = 'translateX(-100%)';
                    wrapper.style.marginLeft = '0px';
                }
            }
            localStorage.setItem('isSidebarOpen', isOpen);
        }

        function switchAuthView(viewId) {
            document.getElementById('register-view').classList.toggle('hidden', viewId !== 'register-view');
            document.getElementById('login-view').classList.toggle('hidden', viewId !== 'login-view');
        }

        // --- File to Base64 Converter (Async to handle file read) ---
        function convertFileToBase64(file) {
            return new Promise((resolve) => {
                if (!file) {
                    resolve(null);
                    return;
                }
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    // Strips the "data:mime/type;base64," prefix.
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = () => resolve(null);
            });
        }

        // --- Conditional Field Toggler ---
        window.toggleIdTypeFields = function(selectedType) {
            const nationalIdGroup = document.getElementById('national-id-front-group');
            const birthCertGroup = document.getElementById('birth-certificate-group');

            nationalIdGroup.classList.add('hidden');
            birthCertGroup.classList.add('hidden');

            // Reset file inputs when hiding (important to prevent submitting old file data)
            document.getElementById('nationalIdFrontInput').value = '';
            document.getElementById('birthCertificateInput').value = '';

            if (selectedType === 'NATIONAL_ID') {
                nationalIdGroup.classList.remove('hidden');
            } else if (selectedType === 'BIRTH_CERTIFICATE') {
                birthCertGroup.classList.remove('hidden');
            }
        };

        // --- Image Preview Handler (for the profile image input) ---
        window.handleImageUpload = function(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('image-preview');
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Profile" class="w-full h-full object-cover">`;
                    document.getElementById('register-image-url').value = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = 'Preview';
                document.getElementById('register-image-url').value = '';
            }
        }
        
        // =======================================================
        // CORE AUTH LOGIC FUNCTIONS
        // =======================================================
        function setUserRole(newRole, userName, imageUrl) {
            const roleDisplay = document.getElementById('role-display');
            const currentPortalHeader = document.getElementById('current-portal-header');
            const currentUserRoleBadge = document.getElementById('current-user-role-badge');
            const navAdmin = document.getElementById('nav-admin');
            const navStudent = document.getElementById('nav-student');

            if (roleDisplay) roleDisplay.textContent = newRole === 'admin' ? 'Admin' : 'Student';

            if (navAdmin) navAdmin.classList.toggle('hidden', newRole !== 'admin');
            if (navStudent) navStudent.classList.toggle('hidden', newRole !== 'student');

            updateProfileIcon({ firstName: userName, imageUrl: imageUrl });

            if (currentPortalHeader) {
                currentPortalHeader.textContent = newRole === 'admin' ? 'Admin Dashboard' : 'Student Dashboard';
            }

            if (currentUserRoleBadge) {
                currentUserRoleBadge.textContent = newRole === 'admin' ? 'ADMIN' : 'STUDENT';
                currentUserRoleBadge.classList.toggle('bg-primary', newRole !== 'admin');
                currentUserRoleBadge.classList.toggle('bg-red-500', newRole === 'admin');
            }

            const toggleIcon = document.getElementById('sidebar-toggle-icon');
            if (toggleIcon) {
                toggleIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>`;
            }
        }

        function finalizeLogin(user) {
            setUserRole(user.role, user.firstName, user.imageUrl);

            const authFlow = document.getElementById('auth-flow');
            const portalFlow = document.getElementById('portal-flow');
            if (authFlow) authFlow.classList.add('hidden');
            if (portalFlow) portalFlow.classList.remove('hidden');

            updateSidebarUserInfo(user);

            const lastView = localStorage.getItem('currentView');
            let defaultView = user.role === 'admin' ? 'admin-dashboard-view' : 'dashboard-view';

            if (lastView && lastView !== 'lecture-detail-view') {
                navigate(lastView);
            } else {
                navigate(defaultView);
            }

            // Save user data to localStorage
            localStorage.setItem('currentUser', JSON.stringify({
                id: user.id,
                email: user.email,
                firstName: user.firstName,
                lastName: user.lastName,
                role: user.role,
                phoneNumber: user.phoneNumber || '',
                imageUrl: user.imageUrl || null
            }));

            const persistedSidebarOpen = localStorage.getItem('isSidebarOpen') !== 'false';
            if (window.innerWidth >= 1024) {
                toggleSidebar(persistedSidebarOpen);
            } else {
                toggleSidebar(false);
            }
        }

        // =======================================================
        // REGISTER HANDLER (API INTEGRATION)
        // =======================================================
        async function handleRegister(event) {
            if (event) event.preventDefault();

            // 1. Collect form data
            const firstName = document.getElementById('register-first-name').value.trim();
            const lastName = document.getElementById('register-last-name').value.trim();
            const email = document.getElementById('register-email').value.toLowerCase().trim();
            const phoneNumber = document.getElementById('register-phone-number').value.trim();
            const parentPhoneNumber = document.getElementById('register-parent-phone-number').value.trim();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const roleSelect = document.getElementById('register-role');
            const role = roleSelect.value;
            const levelSelect = document.getElementById('register-level');
            const level = levelSelect.value;
            const nationalId = document.getElementById('register-national-id').value.trim(); 
            const idType = document.getElementById('register-id-type').value; 

            // File input elements
            const profileFile = document.getElementById('register-image-input').files[0];
            const nationalIdFrontFile = document.getElementById('nationalIdFrontInput').files[0];
            const birthCertificateFile = document.getElementById('birthCertificateInput').files[0];

            // 2. Client-side Validation
            if (password !== confirmPassword) {
                showMessage('Registration Failed', 'Password and Confirm Password must match.');
                return;
            }
            if (!role || !level || !idType) {
                showMessage('Registration Failed', 'Please complete all required fields: Role, Level, and Identification Type.');
                return;
            }
            const parentNumberLong = parseInt(parentPhoneNumber.replace(/\D/g, ''));
            if (isNaN(parentNumberLong)) {
                showMessage('Registration Failed', 'Invalid Parent Phone Number format.');
                return;
            }
            if (!nationalId) {
                showMessage('Registration Failed', 'National ID is required.');
                return;
            }

            // 3. Conditional File Validation and Conversion (Awaited)
            showMessage('Processing...', 'Converting images and sending data to the server.');

            // User Profile Image (Optional field in DTO)
            const userImageBase64 = await convertFileToBase64(profileFile);

            // Conditional Document Image (Required based on selection)
            let nationalIdFrontBase64 = null;
            let birthCertificateBase64 = null;

            if (idType === 'NATIONAL_ID') {
                if (!nationalIdFrontFile) {
                    showMessage('Registration Failed', 'Please upload the National ID Front image.');
                    return;
                }
                nationalIdFrontBase64 = await convertFileToBase64(nationalIdFrontFile);
            } else if (idType === 'BIRTH_CERTIFICATE') {
                 if (!birthCertificateFile) {
                    showMessage('Registration Failed', 'Please upload the Birth Certificate image.');
                    return;
                }
                birthCertificateBase64 = await convertFileToBase64(birthCertificateFile);
            }

            // 4. API Payload
            try {
                const payload = {
                    firstName: firstName,
                    lastName: lastName,
                    email: email,
                    phoneNumber: phoneNumber,
                    password: password,
                    role: role.toUpperCase(), 
                    
                    // User Profile Image
                    userImage: userImageBase64,
                    
                    // Student-specific fields
                    nationalId: nationalId,
                    parentNumber: parentNumberLong,
                    idType: idType,
                    levelOfEducation: level,
                    nationalIdFront: nationalIdFrontBase64,
                    birthCertificate: birthCertificateBase64
                };

                // 5. API Call
                const response = await fetch(`${SERVER_URL}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                if (response.status === 409) {
                    showMessage('Registration Failed', 'An account with this email already exists. Please log in.');
                    return;
                }

                if (!response.ok) {
                    const errorDetails = await response.json().catch(() => ({ message: 'Server error occurred during registration.' }));
                    throw new Error(errorDetails.message || `Registration failed with status: ${response.status}`);
                }

                const registeredUser = await response.json();

                // Successful registration
                showMessage('Registration Successful', `Account created for ${registeredUser.email}! Please log in with your credentials.`);
                
                // Add to mock data for local testing fallback (optional)
                if (!registeredUsers.find(u => u.email === registeredUser.email)) {
                    registeredUsers.push({ ...registeredUser, password: password });
                }
                
                switchAuthView('login-view');
                document.getElementById('login-email').value = registeredUser.email;

            } catch (error) {
                console.error('Registration Error:', error);
                showMessage('Registration Failed', `An error occurred: ${error.message}`);
            }
        }
        window.handleRegister = handleRegister;


        // =======================================================
        // LOGIN HANDLER (API INTEGRATION)
        // =======================================================
        async function handleLogin(event) {
            if (event) event.preventDefault();
            const email = document.getElementById('login-email').value.toLowerCase().trim();
            const password = document.getElementById('login-password').value;

            try {
                // 1. API Call
                const response = await fetch(`${SERVER_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: email, password: password }),
                });

                if (!response.ok) {
                    throw new Error('Invalid email or password.');
                }

                const user = await response.json();

                // 2. Client-side Login Finalization
                localStorage.removeItem('currentView');
                localStorage.setItem('isSidebarOpen', 'true');
                finalizeLogin(user);
                showMessage('Login Successful', `Welcome back, ${user.firstName || user.email}!`);

            } catch (error) {
                // --- MOCK FALLBACK ---
                const mockUser = registeredUsers.find(u => u.email === email && u.password === password);
                
                if (mockUser) {
                    localStorage.removeItem('currentView');
                    localStorage.setItem('isSidebarOpen', 'true');
                    finalizeLogin(mockUser);
                    showMessage('Login Successful (Mock)', `Welcome back (Mock), ${mockUser.firstName || mockUser.email}!`);
                } else {
                    console.error('Login Error:', error);
                    showMessage('Login Failed', error.message || 'Invalid email or password.');
                }
            }
        }
        window.handleLogin = handleLogin;

        // =======================================================
        // LOGOUT HANDLER (API INTEGRATION)
        // =======================================================
        async function handleLogout() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            try {
                if (currentUser && currentUser.id) {
                    await fetch(`${SERVER_URL}/logout?userId=${currentUser.id}`, {
                        method: 'POST'
                    });
                }
            } catch (error) {
                console.warn("Logout API call failed, continuing local cleanup:", error);
            }

            // Local Cleanup
            localStorage.removeItem('currentUser');
            localStorage.removeItem('currentView');
            localStorage.setItem('isSidebarOpen', 'true');

            document.getElementById('portal-flow').classList.add('hidden');
            document.getElementById('auth-flow').classList.remove('hidden');
            
            switchAuthView('login-view');
            showMessage('Logout Successful', 'You have been logged out. Please register or log in again.');
        }
        window.handleLogout = handleLogout;


        // =======================================================
        // PERSISTENT LOGIN CHECK ON PAGE LOAD
        // =======================================================
        window.addEventListener('DOMContentLoaded', () => {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));

            if (currentUser) {
                finalizeLogin(currentUser);
            } else {
                document.getElementById('portal-flow').classList.add('hidden');
                document.getElementById('auth-flow').classList.remove('hidden');
                switchAuthView('login-view');
            }

            const persistedSidebarOpen = localStorage.getItem('isSidebarOpen') !== 'false';
            if (window.innerWidth >= 1024) {
                toggleSidebar(persistedSidebarOpen);
            } else {
                toggleSidebar(false);
            }
        });
    </script>
</body>

</html>