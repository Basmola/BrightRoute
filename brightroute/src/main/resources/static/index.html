<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrightRoute - Learn & Grow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link rel="stylesheet" href="css/styles.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 900: '#111827', 800: '#1f2937', 50: '#f9fafb' },
                        accent: { DEFAULT: '#3b82f6', hover: '#2563eb' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
</head>

<body class="bg-brand-50 text-gray-800 font-sans antialiased">

    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-2">
                    <i class="ph-fill ph-graduation-cap text-accent-DEFAULT text-3xl"></i>
                    <span class="font-bold text-xl tracking-wide text-gray-900">BrightRoute</span>
                </div>
                <div class="hidden md:flex items-center gap-6">
                    <a href="#" class="text-gray-600 hover:text-accent-DEFAULT font-medium transition-colors">Home</a>
                    <a href="#courses"
                        class="text-gray-600 hover:text-accent-DEFAULT font-medium transition-colors">Courses</a>
                    <div id="auth-buttons" class="flex items-center gap-3">
                        <!-- Dynamic Content -->
                    </div>
                </div>
                <button class="md:hidden p-2 text-gray-600"><i class="ph ph-list text-2xl"></i></button>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <header class="bg-brand-900 text-white py-20 lg:py-32 relative overflow-hidden">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10 text-center">
            <h1 class="text-4xl md:text-6xl font-bold mb-6 leading-tight">
                Unlock Your Potential with <span class="text-accent-DEFAULT">BrightRoute</span>
            </h1>
            <p class="text-lg md:text-xl text-gray-300 mb-10 max-w-2xl mx-auto">
                Discover expert-led courses to advance your career and skills. Join our community of learners today.
            </p>
            <a href="#courses"
                class="px-8 py-3 bg-accent-DEFAULT hover:bg-accent-hover text-white rounded-full font-bold text-lg transition-transform hover:scale-105 shadow-lg shadow-blue-900/50 inline-flex items-center gap-2">
                Explore Courses <i class="ph-bold ph-arrow-right"></i>
            </a>
        </div>
        <!-- Decorative Background -->
        <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
            <i class="ph-fill ph-code absolute top-10 left-10 text-9xl"></i>
            <i class="ph-fill ph-atom absolute bottom-20 right-20 text-9xl"></i>
            <i
                class="ph-fill ph-globe absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-[20rem]"></i>
        </div>
    </header>

    <!-- Courses Section -->
    <section id="courses" class="py-16 lg:py-24">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">Featured Courses</h2>
                <p class="text-gray-600 max-w-2xl mx-auto">Explore our wide range of courses designed to help you master
                    new skills.</p>
            </div>

            <div id="courses-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Courses will be loaded here -->
                <div class="col-span-full flex justify-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-accent-DEFAULT"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-900 text-gray-400 py-12 border-t border-gray-800">
        <div
            class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="flex items-center gap-2">
                <i class="ph-fill ph-graduation-cap text-gray-100 text-2xl"></i>
                <span class="font-bold text-lg text-gray-100">BrightRoute</span>
            </div>
            <p class="text-sm">Â© 2024 BrightRoute. All rights reserved.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="js/DataStore.js"></script>
    <script>
        // Logout Handler
        function handleLogout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'Login&Register.html';
        }
        window.handleLogout = handleLogout;

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Check Auth Status
            const user = getLoggedInUser();
            const authContainer = document.getElementById('auth-buttons');

            if (user) {
                const dashboardLink = user.role === 'ADMIN' ? 'admin_dashboard.html' : 'student_dashboard.html';
                authContainer.innerHTML = `
                    <span class="text-sm font-medium text-gray-700">Hi, ${user.firstName}</span>
                    <a href="${dashboardLink}" class="px-5 py-2 bg-brand-900 text-white rounded-lg hover:bg-brand-800 transition-colors font-medium">Dashboard</a>
                    <button onclick="handleLogout()" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">Logout</button>
                `;
            } else {
                authContainer.innerHTML = `
                    <a href="Login&Register.html" class="text-gray-600 hover:text-accent-DEFAULT font-medium transition-colors">Log In</a>
                    <a href="Login&Register.html" class="px-5 py-2 bg-accent-DEFAULT text-white rounded-lg hover:bg-accent-hover transition-colors font-medium">Sign Up</a>
                `;
            }

            // 2. Load Courses
            const coursesGrid = document.getElementById('courses-grid');
            if (typeof fetchAndStoreCourses === 'function') {
                const courses = await fetchAndStoreCourses();
                let subscribedCourseIds = new Set();

                // Fetch subscriptions if logged in
                if (user) {
                    try {
                        const subRes = await fetch(`http://localhost:7070/api/course-subscription/user/${user.id}`);
                        if (subRes.ok) {
                            const subs = await subRes.json();
                            subs.forEach(c => subscribedCourseIds.add(c.courseId));
                        }
                    } catch (err) {
                        console.error('Error fetching subscriptions:', err);
                    }
                }

                if (courses && courses.length > 0) {
                    coursesGrid.innerHTML = courses.map(course => {
                        const isSubscribed = subscribedCourseIds.has(course.id);
                        const buttonHtml = isSubscribed
                            ? `<button onclick="handleUnsubscribe(${course.id}, this)" class="block w-full text-center py-2.5 border border-green-200 bg-green-100 text-green-700 rounded-lg font-medium hover:bg-red-100 hover:text-red-700 hover:border-red-200 transition-colors group-subscribed">
                                 <span class="group-subscribed-hover:hidden"><i class="ph-fill ph-check-circle"></i> Subscribed</span>
                                 <span class="hidden group-subscribed-hover:inline"><i class="ph-bold ph-x-circle"></i> Unsubscribe</span>
                               </button>`
                            : `<button onclick="handleEnrollment(${course.id}, this)" class="block w-full text-center py-2.5 border border-gray-300 rounded-lg text-gray-700 font-medium hover:border-accent-DEFAULT hover:text-accent-DEFAULT transition-colors">
                                 Subscribe
                               </button>`;

                        return `
                        <div class="bg-white border border-gray-200 rounded-xl overflow-hidden hover:shadow-xl transition-all duration-300 group">
                            <div class="h-48 bg-gray-200 relative overflow-hidden">
                                <img src="${course.image}" alt="${course.title}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                                <div class="absolute top-3 right-3 bg-white/90 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-bold text-gray-800 shadow-sm">
                                    Level ${course.level}
                                </div>
                            </div>
                            <div class="p-6">
                                <h3 class="text-xl font-bold text-gray-900 mb-2 group-hover:text-accent-DEFAULT transition-colors">${course.title}</h3>
                                <p class="text-sm text-gray-500 mb-4 flex items-center gap-2">
                                    <i class="ph-bold ph-chalkboard-teacher"></i> ${course.instructor}
                                </p>
                                <p class="text-gray-600 text-sm line-clamp-2 mb-6">${course.description}</p>
                                ${buttonHtml}
                            </div>
                        </div>
                    `}).join('');
                } else {
                    coursesGrid.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <i class="ph ph-books text-4xl text-gray-300 mb-3"></i>
                            <p class="text-gray-500 text-lg">No courses available at the moment.</p>
                        </div>
                    `;
                }
            }
        });

        // Enrollment Handler
        async function handleEnrollment(courseId, btnElement) {
            const user = getLoggedInUser();

            if (!user) {
                // Not logged in -> Redirect to Login
                window.location.href = 'Login&Register.html';
                return;
            }

            // Optional: Show loading state
            const originalText = btnElement.textContent;
            btnElement.textContent = 'Processing...';
            btnElement.disabled = true;

            // Logged in -> Subscribe via API
            try {
                const response = await fetch(`http://localhost:7070/api/course-subscription/subscribe?userId=${user.id}&courseId=${courseId}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    // Success UI Update
                    btnElement.textContent = 'Subscribed';
                    btnElement.classList.remove('hover:border-accent-DEFAULT', 'hover:text-accent-DEFAULT', 'text-gray-700', 'border-gray-300');
                    btnElement.classList.add('bg-green-100', 'text-green-700', 'border-green-200', 'cursor-not-allowed');
                    // btnElement.disabled = true; // Already disabled
                    alert('Successfully enrolled in the course!');
                    window.location.reload();
                } else {
                    const errorText = await response.text();
                    alert('Enrollment failed: ' + errorText);
                    // Revert button state on failure
                    btnElement.textContent = originalText;
                    btnElement.disabled = false;
                }
            } catch (error) {
                console.error('Enrollment error:', error);
                alert('An error occurred while enrolling. Please try again.');
                // Revert button state on error
                btnElement.textContent = originalText;
                btnElement.disabled = false;
            }
        }
        window.handleEnrollment = handleEnrollment;

        // Unsubscribe Handler
        async function handleUnsubscribe(courseId, btnElement) {
            const user = getLoggedInUser();
            if (!confirm('Are you sure you want to unsubscribe from this course?')) return;

            const originalText = btnElement.innerHTML;
            btnElement.textContent = 'Processing...';
            btnElement.disabled = true;

            try {
                const response = await fetch(`http://localhost:7070/api/course-subscription/unsubscribe?userId=${user.id}&courseId=${courseId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Successfully unsubscribed!');
                    window.location.reload();
                } else {
                    const errorText = await response.text();
                    alert('Unsubscribe failed: ' + errorText);
                    btnElement.innerHTML = originalText;
                    btnElement.disabled = false;
                }
            } catch (error) {
                console.error('Unsubscribe error:', error);
                alert('An error occurred. Please try again.');
                btnElement.innerHTML = originalText;
                btnElement.disabled = false;
            }
        }
        window.handleUnsubscribe = handleUnsubscribe;
    </script>
</body>

</html>